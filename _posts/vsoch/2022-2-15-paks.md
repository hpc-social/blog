---
author: Vanessasaurus
author_tag: vsoch
blog_subtitle: dinosaurs, programming, and parsnips
blog_title: VanessaSaurus
blog_url: https://vsoch.github.io/
category: vsoch
date: '2022-02-15 12:30:00'
layout: post
original_url: https://vsoch.github.io/2022/paks/
slug: interactive-development-containers
title: Interactive Development Containers
---

<p>Iâ€™ve recently been interested in developer workflows. Aside from being a developer, I feel
like the tooling for our community, and especially for HPC or hybrid environments, is lacking.
As a simple example, letâ€™s ask a basic question:</p>


<blockquote>
  <p>How do I start developing here and move it over there?</p>

</blockquote>

<p>For the most part, creating a development container is fairly straight forward, and we can even bind source
code to the host to work on in one editor terminal and then build and run or test in another. However,
for the moving part, it gets shoddy. Our best bet is to rebuild the container with the 
most updated source code, push to a registry, and then pull down somewhere else.
For a container that is a binary and not layers provided by a registry, we could even scp it.
If we do this right, we will have an automated build and deploy that triggers when we 
merge new code into main, but do you see the problem? What about the code that we want
to test that isnâ€™t ready to merge? This is why we typically would need to manually
push to a registry with some kind of â€œwork in progressâ€ tag and then pull somewhere else.
Minimally weâ€™d need to build fresh again, and then reproduce all the steps to set up our environment.</p>


<h2 id="interactive-development-containers">Interactive Development Containers</h2>

<p>Now I donâ€™t have all the answers, but recently <a href="https://github.com/alecbcs" target="_blank">@alecbcs</a> and
I have been dreaming about what kinds of development environments we want.
functionality such as:</p>


<ol class="custom-counter">
  <li>Saving the container state without leaving it.</li>
  <li>Loading or saving or otherwise interacting with named environments.</li>
  <li>Inspecting or interacting with container metadata, also without leaving the container.</li>
  <li>Moving files or sizing the container without the same.</li>
</ol>

<p>And actually I wonâ€™t even get to answering the first question in this post about moving something
from one place to another, but rest assured it is an important one. This post is about some prototype 
or fun testing work that weâ€™ve started around these ideas.
The playground for some of these early ideas has been <a href="https://syspack.github.io/paks/" target="_blank">Paks</a>.</p>


<div style="padding: 20px;">
 <img src="https://github.com/syspack/paks/raw/main/docs/assets/img/paks.png" />
</div>


<p>Paks is a Python library that Iâ€™m calling a developer wrapper for containers.
Mind you, itâ€™s more of a playground right now to experiment with ideas. But Iâ€™ve had so
much fun even this early on that I want to share what Iâ€™ve learned.</p>


<h3 id="wrapper">Wrapper</h3>

<p>Because Paks is a wrapper, you will run containers using the paks command. Here are a few quick examples.</p>


<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nv">$ </span>paks run ubuntu
<span class="nv">$ </span>paks run <span class="nt">--shell</span> /bin/sh busybox
<span class="nv">$ </span>paks run <span class="nt">--container-tech</span> podman busybox

</code></pre></div>
</div>


<p>What is happening on the backend that took me a bit to figure out is that we will need to run a subprocess,
but create a <a href="https://docs.python.org/3/library/pty.html" target="_blank">pseudo terminal</a> to better
watch and interact with it. This is going to happen in the â€œinteractive_terminalâ€ command below. But unless you
want your terminal to get wonky, we need to use <a href="https://docs.python.org/3/library/termios.html" target="_blank">termios</a> to 
grab the current tty and make sure it gets restored no matter what at the end. That looks like this:</p>


<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="k">def</span> <span class="nf">interactive_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
        <span class="s">"""
        Ensure we always restore original TTY otherwise terminal gets messed up
        """</span>
        <span class="c1"># Controller to get history
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">hist</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">commands</span><span class="p">.</span><span class="n">history</span>

        <span class="c1"># save original tty setting then set it to raw mode
</span>        <span class="n">old_tty</span> <span class="o">=</span> <span class="n">termios</span><span class="p">.</span><span class="n">tcgetattr</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">stdin</span><span class="p">)</span>
        <span class="n">old_pty</span> <span class="o">=</span> <span class="n">termios</span><span class="p">.</span><span class="n">tcgetattr</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_interactive_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">termios</span><span class="p">.</span><span class="n">tcsetattr</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">stdin</span><span class="p">,</span> <span class="n">termios</span><span class="p">.</span><span class="n">TCSADRAIN</span><span class="p">,</span> <span class="n">old_tty</span><span class="p">)</span>
            <span class="n">termios</span><span class="p">.</span><span class="n">tcsetattr</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">termios</span><span class="p">.</span><span class="n">TCSADRAIN</span><span class="p">,</span> <span class="n">old_pty</span><span class="p">)</span>

</code></pre></div>
</div>


<p>What happens if you donâ€™t do that? Your terminal gets weird and wonky. And then in the interactive
command function, this is where we launch a subprocess with a new pseudo terminal:</p>


<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
        <span class="n">tty</span><span class="p">.</span><span class="n">setraw</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="n">fileno</span><span class="p">())</span>

        <span class="c1"># open pseudo-terminal to interact with subprocess
</span>        <span class="n">openpty</span><span class="p">,</span> <span class="n">opentty</span> <span class="o">=</span> <span class="n">pty</span><span class="p">.</span><span class="n">openpty</span><span class="p">()</span>

        <span class="c1"># use os.setsid() make it run in a new process group, or bash job control will not be enabled
</span>        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">Popen</span><span class="p">(</span>
            <span class="n">cmd</span><span class="p">,</span>
            <span class="n">preexec_fn</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">setsid</span><span class="p">,</span>
            <span class="n">stdin</span><span class="o">=</span><span class="n">opentty</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">opentty</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">opentty</span><span class="p">,</span>
            <span class="n">universal_newlines</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Welcome to Paks!
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">welcome</span><span class="p">(</span><span class="n">openpty</span><span class="p">)</span>

</code></pre></div>
</div>


<p>The <a href="https://stackoverflow.com/questions/45911705/why-use-os-setsid-in-python" target="_blank">setsid</a> as a pre-exec function
 is ensuring the child process is a new session and wonâ€™t exit, sort of akin to a daemon. 
So at face value, yes it is doing exactly what you think - we are shelling into the container
and watching the command line and looking for paks-known commands. And I didnâ€™t use a Python keylogger because
I found that <a href="https://github.com/boppreh/keyboard" target="_blank">keyboard</a> requires sudo (like really?!) 
and <a href="https://pynput.readthedocs.io/en/latest/" target="_blank">pynput</a> is really scary because it doesnâ€™t just get keys from the terminal - itâ€™s watching anything you type anywhere! That gave me the heebie jeebies. I hope there is some scanner for pypi that is looking for that package
and checking itâ€™s not being malicious.</p>


<p>All of the above said, and all the time spent, Iâ€™m not convinced that this exact method is
the best way to be running commands from inside the container. There are other ideas
that need to be tested!</p>


<h3 id="structure">Structure</h3>

<p>We could have talked about this first, but let me show you the basic structure of paks
so you get an understanding of the components.</p>


<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>paks

# Backends are different wrappers, so logically we start with podman and docker
â”œâ”€â”€ backends
â”‚Â Â  â”œâ”€â”€ base.py
â”‚Â Â  â”œâ”€â”€ docker.py
â”‚Â Â  â”œâ”€â”€ __init__.py
â”‚Â Â  â””â”€â”€ podman.py

# The client is what you interact with on the command line. This shows the various commands available.
â”œâ”€â”€ cli
â”‚Â Â  â”œâ”€â”€ config.py
â”‚Â Â  â”œâ”€â”€ env.py
â”‚Â Â  â”œâ”€â”€ __init__.py
â”‚Â Â  â””â”€â”€ run.py

# This is a central controller for things
â”œâ”€â”€ client.py

# Here's all the built-in, interactive commands paks supports!
â”œâ”€â”€ commands
â”‚Â Â  â”œâ”€â”€ command.py
â”‚Â Â  â”œâ”€â”€ cp.py
â”‚Â Â  â”œâ”€â”€ env.py
â”‚Â Â  â”œâ”€â”€ history.py
â”‚Â Â  â”œâ”€â”€ __init__.py
â”‚Â Â  â”œâ”€â”€ inspect.py
â”‚Â Â  â””â”€â”€ state.py
â”œâ”€â”€ defaults.py
â”œâ”€â”€ env.py
â”œâ”€â”€ logger.py

# Coming soon - load your own commands!
â”œâ”€â”€ plugins.py
â”œâ”€â”€ schemas.py
â”œâ”€â”€ settings.py
â”œâ”€â”€ settings.yml
â”œâ”€â”€ templates.py
â”œâ”€â”€ utils
â””â”€â”€ version.py
</code></pre></div>
</div>


<p>So that should give you the gist - we have container wrappers (backends) and then
commands that we can issue while we are inside the container. Letâ€™s talk about them next.</p>


<h3 id="saving-state">Saving State</h3>

<p>The first thing I wanted to try with Paks was to save a container state, but not needing
to open a separate terminal and save from the outside. The use case for this is that given Iâ€™m in an interactive
container and Iâ€™ve made some changes, I donâ€™t want to exit and rebuild. All yâ€™all reproducibility folks
can stop wincing, and realize that we also need more temporary or throwaway development environments like this.
Reproducibilty is important, but mostly for the final production thing, and only up to a level of not
giving us pain. So how might I do this?</p>


<p>For paks, while you are inside the container (letâ€™s say ubuntu) you simply ask to <code class="language-plaintext highlighter-rouge">#save</code>:</p>


<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
$ paks run ubuntu
# touch PANCAKES
# #save
Saving container...
sha256:d82aaa268feb59344cf31a757ce7f5c0caa6a6bbd10b8d0af1d55cdbc50b609b
[+] Building 0.2s (5/5) FINISHED
...
=&gt; =&gt; writing image sha256:f58ae524d8644400b33c078f19612cba7849ef8f3ea158e2291ac697a4129080
=&gt; =&gt; naming to docker.io/library/busybox-saved
Untagged: dockerio-busybox-joyous-hippo-3922-gloopy-peanut-9044:latest
Deleted: sha256:d82aaa268feb59344cf31a757ce7f5c0caa6a6bbd10b8d0af1d55cdbc50b609b
Deleted: sha256:f58ae524d8644400b33c078f19612cba7849ef8f3ea158e2291ac697a4129080
Successfully saved container! â­ï¸
</code></pre></div>
</div>


<p>And then you can see that there is an ubuntu-saved container!</p>


<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nv">$ </span>docker images | <span class="nb">grep </span>ubuntu
ubuntu-saved                                      latest    93e336d994de   2 minutes ago   72.8MB
ubuntu                                            latest    54c9d81cbb44   7 days ago      72.8MB

</code></pre></div>
</div>


<p>So this has saved me some tiny bit of energy to open up another terminal, remember how to docker commit,
and then also rebuild with a squash to minimize the layers (as there is a maximum number we donâ€™t want to hit).
What Paks could then eventually do is make it easy to move this entire container between
places, e.g., from your local machine to HPC without a hitch. I havenâ€™t started to work on that yet
because this is a fun side project.</p>


<h3 id="environments">Environments</h3>

<p>One thing I do a lot is use GitHub tokens to do fun stuff with the API. I usually need to
keep this in some hidden file, then find it, open it, copy paste it, and export it in the container.
And then I do that a million times when I have to run a new container. But with Paks, we can 
create a named environment on the host (a file to source with exports):</p>


<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nv">$ </span>paks <span class="nb">env </span>edit github
You can also quickly show an environment:

<span class="nv">$ </span>paks <span class="nb">env </span>show github
<span class="nv">GITHUB_TOKEN</span><span class="o">=</span>xxxxxxxxxxx

</code></pre></div>
</div>


<p>And then in our container, as many times as we need, load it seamlessly!</p>


<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
root@9ec6c3d43591:/# <span class="c">#envload github</span>
Loading environment...
Successfully loaded environment github

root@9ec6c3d43591:/#  <span class="nb">export </span><span class="nv">GITHUB_TOKEN</span><span class="o">=</span>xxxxxxxxx
root@9ec6c3d43591:/#  <span class="nb">export </span><span class="nv">GITHUB_USER</span><span class="o">=</span>dinosaur

</code></pre></div>
</div>


<p>If only my GitHub username was dinosaur! ğŸ˜ï¸ Is it loaded?</p>


<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
root@9ec6c3d43591:/# <span class="nb">env</span> | <span class="nb">grep </span>GITHUB
<span class="nv">GITHUB_USER</span><span class="o">=</span>dinosaur
<span class="nv">GITHUB_TOKEN</span><span class="o">=</span>xxxxxxxxx

</code></pre></div>
</div>


<p>Okay, so to be fair, there are a bunch of other commands for inspection and size,
and Iâ€™m not going to go through them all! You can see them 
<a href="https://syspack.github.io/paks/getting_started/user-guide.html" target="_blank">in the Paks user guide</a>.
And I donâ€™t mean to say you should use this - you probably shouldnâ€™t. But you might be interested to try it out.</p>


<h3 id="parsing-keystrokes">Parsing Keystrokes</h3>

<p>So the most interesting part of this project has been learning about input from the terminal,
and actually the reason I wanted to write this post to share what I learned. Letâ€™s go back to the interactive
function where we ran subprocess and created a pseudo terminal. There actually is a pretty simple way
to watch what is being typed:</p>


<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># This is the subprocess return code, keep going until we are done (e.g. have a return code)
</span><span class="k">while</span> <span class="n">p</span><span class="p">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>

    <span class="c1"># Wait for io completion (e.g., see man select)
</span>    <span class="n">r</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">select</span><span class="p">.</span><span class="n">select</span><span class="p">([</span><span class="n">sys</span><span class="p">.</span><span class="n">stdin</span><span class="p">,</span> <span class="n">openpty</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[])</span>

    <span class="c1"># Was it a new input?
</span>    <span class="k">if</span> <span class="n">sys</span><span class="p">.</span><span class="n">stdin</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
        <span class="n">terminal_input</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">10240</span><span class="p">)</span>
        <span class="n">new_char</span> <span class="o">=</span> <span class="n">terminal_input</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">"utf-8"</span><span class="p">)</span>

        <span class="c1"># Do something with what you see here
</span>
    <span class="c1"># Was it a new output?
</span>    <span class="k">elif</span> <span class="n">openpty</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">openpty</span><span class="p">,</span> <span class="mi">10240</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">o</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">o</span><span class="p">)</span>
</code></pre></div>
</div>


<p>I learned a lot from this! Letâ€™s talk about it.</p>


<h4 id="debugging">Debugging</h4>

<p>So the first thing I learned is that my typical â€œimport IPythonâ€ and â€œIPython.embed()â€
isnâ€™t going to work as easily as normal, because (at least superficially) I didnâ€™t
see a way to have it sort of injected into the process. Anything that is interactive in
that loop is still (conceptually) running on my host. So when I use IPython
it does some weird stuff with carriage returns, but itâ€™s still possible to interact with
a little bit. So what I wound up doing so I could easily see every keypress was to write
to file in append mode:</p>


<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'/tmp/file.txt'</span><span class="p">,</span> <span class="s">'a'</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
    <span class="n">fd</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_char</span><span class="p">)</span>
</code></pre></div>
</div>


<p>This was kind of neat because I could be typing in one terminal, and then have
a file open (watching it) that updates with changes, and Iâ€™d get a sense of what
is going on. I could append anything to this file to debug. And this is also really
different from how we normally use subprocess, where maybe we will parse entire lines
at once:</p>


<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">Popen</span><span class="p">([</span><span class="s">'python'</span><span class="p">,</span><span class="s">'thing.py'</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">)</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
  <span class="n">line</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">readline</span><span class="p">()</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
    <span class="k">break</span>
</code></pre></div>
</div>


<p>because we are reading on character at a time! So what we essentially need to do
is keep a string that we continue appending to unless there is a newline, up or down,
or left or right to indicate moving the cursor.</p>


<h4 id="ascii-characters">Ascii Characters</h4>

<p>I started to quickly see characters that my editor didnâ€™t know - e.g., likely
escape sequences and other ascii that showed up in the little question mark box.
I quickly realized that I was seeing <a href="https://www.w3resource.com/python-exercises/python-basic-exercise-86.php" target="_blank">ascii</a>
code (and some characters that couldnâ€™t be parsed) so the solution was to look at the ord
of the character and compare to a number. For example, for a backspace
the number is 127. So to act on it I might do:</p>


<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1"># if we have a backspace (ord 127)
</span><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_char</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">ord</span><span class="p">(</span><span class="n">new_char</span><span class="p">)</span> <span class="o">==</span> <span class="mi">127</span><span class="p">:</span>

    <span class="c1"># This is our in progress line. If we have content, backspace!
</span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">string_input</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">string_input</span> <span class="o">=</span> <span class="n">string_input</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="c1"># But if we don't, just write the character for the person to see and 
</span>    <span class="c1"># keep collecting new characters (continue in the loop)
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">string_input</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">openpty</span><span class="p">,</span> <span class="n">terminal_input</span><span class="p">)</span>
        <span class="k">continue</span>
    
<span class="c1"># Otherwise (not a backspace) add to our growing line to parse further!
</span><span class="k">else</span><span class="p">:</span>
    <span class="n">string_input</span> <span class="o">=</span> <span class="n">string_input</span> <span class="o">+</span> <span class="n">new_char</span>
</code></pre></div>
</div>


<p>The above is basically looking for a backspace, and if we find one, we remove
one character from the line we are assembling. Otherwise we just add the new character
to the line.</p>


<h4 id="xterm-sequences">xterm sequences</h4>

<p>And a similar thing happens for pressing up/down and right/left, except the
terminal parses them as â€œ[Aâ€, â€œ[Bâ€, â€œ[Câ€, and â€œ[Dâ€, respectively, and often with
an escape sequence first. There are <a href="https://en.wikipedia.org/wiki/ANSI_escape_code" target="_blank">some nice tables here</a>
for the interested reader! And this was also the point that I realized how challenging parsing input is!
Along with needing to account for every character, you also need to account for platform
differences. Thatâ€™s also why I view this library as mostly for development and thinking,
or at least for mostly Linux and bash shells, because Iâ€™m not sure I could ever handle them all.
So for the purposes of my library, for now I decided Iâ€™m not going to handle moving left and right,
nor do I want to deal with weird extra ascii characters that are added, so I just clean them up.</p>


<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1"># Get rid of left/right
</span><span class="n">string_input</span> <span class="o">=</span> <span class="n">string_input</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"[D"</span><span class="p">,</span> <span class="s">""</span><span class="p">).</span><span class="n">replace</span><span class="p">(</span><span class="s">"[C"</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>

<span class="c1"># Replace weird characters and escape sequences
</span><span class="n">string_input</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">clean</span><span class="p">(</span><span class="n">string_input</span><span class="p">)</span>
</code></pre></div>
</div>


<p>Yes, that probably means some of your ninja shortcuts wonâ€™t work perfectly when running paks,
and if you absolutely want one to be parsed please let me know and we can add it.</p>


<h4 id="newlines">Newlines</h4>

<p>So the gold nugget of content that Paks is interested in is when you press enter.
This means youâ€™ve finished typing something and there is some version of a newline
or carriage return. This is also a pretty variable thing depending on the platform you are
on - newlines can come in very different forms! I tried to honor the two that I see most often:</p>


<ol class="custom-counter">
  <li><strong>\r\n</strong>: Windows </li>
  <li><strong>\n</strong>: UNIX (e.g., Mac OSX)</li>
  <li><strong>\r</strong>: Mac (pre OSX)</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">has_newline</span> <span class="o">=</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span> <span class="ow">in</span> <span class="n">string_input</span> <span class="ow">or</span> <span class="s">"</span><span class="se">\r</span><span class="s">"</span> <span class="ow">in</span> <span class="n">string_input</span>
</code></pre></div>
</div>


<p>At this point, we can start acting on what we see. E.g., if the user has asked for any
kind of exit, I honor it.</p>


<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Universal exit command
</span><span class="k">if</span> <span class="s">"exit"</span> <span class="ow">in</span> <span class="n">string_input</span> <span class="ow">and</span> <span class="n">has_newline</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n\r</span><span class="s">Container exited.</span><span class="se">\n\r</span><span class="s">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">uri</span><span class="p">.</span><span class="n">extended_name</span>
</code></pre></div>
</div>


<p>The return of the name at the end is to handle cleaning up the image, which was allocated
a temporary name.</p>


<h3 id="history">History</h3>

<p>One of the more interesting parts of this project was realizing that people use history, a lot.
At least I do. This is going to appear as an up or down press, and only when a newline is found 
is some item in history re-executed. So first letâ€™s look for exploring history with up/down. There are
two cases - pressing up/down without a newline:</p>


<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Pressing up or down, but not enter
</span><span class="k">if</span> <span class="p">(</span><span class="s">"[A"</span> <span class="ow">in</span> <span class="n">string_input</span> <span class="ow">or</span> <span class="s">"[B"</span> <span class="ow">in</span> <span class="n">string_input</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_newline</span><span class="p">:</span>
    <span class="n">string_input</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_history</span><span class="p">(</span><span class="n">string_input</span><span class="p">,</span> <span class="n">openpty</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">openpty</span><span class="p">,</span> <span class="n">terminal_input</span><span class="p">)</span>
    <span class="k">continue</span>
</code></pre></div>
</div>


<p>And with one:</p>


<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Pressing up or down with enter
</span><span class="k">if</span> <span class="p">(</span><span class="s">"[A"</span> <span class="ow">in</span> <span class="n">string_input</span> <span class="ow">or</span> <span class="s">"[B"</span> <span class="ow">in</span> <span class="n">string_input</span><span class="p">)</span> <span class="ow">and</span> <span class="n">has_newline</span><span class="p">:</span>
    <span class="n">string_input</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_history</span><span class="p">(</span><span class="n">string_input</span><span class="p">,</span> <span class="n">openpty</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">openpty</span><span class="p">,</span> <span class="n">terminal_input</span><span class="p">)</span>
</code></pre></div>
</div>


<p>If we donâ€™t have a newline, we add a continue to keep parsing characters the user is
typing. If we do have a newline, we let the loop keep running to keep parsing the line of history we retrieved.
But letâ€™s step back and talk about that history. We basically want to retrieve whatever line of history that
the user is asking for, because to us it looks like up and down errors. You could imagine
restoring the previous line, and then editing it. This actually proved to be quite challenging,
because I realized (by default) when we start running a container (well, ubuntu and centos)
the history is stored in memory and not written to ~/.bash_history. This led to 
<a href="https://twitter.com/vsoch/status/1492377777684639748" target="_blank">this thread</a> and some people coming in to <a href="https://twitter.com/ajdecon/status/1492381132998033409" target="_blank">quickly help</a>
and others coming in just to say â€œWhy are you doing this with containers it makes no sense stop.â€ Yeah, right. If I
listened to every person that has ever told me to stop working on something because â€œREASONS!â€ I wouldnâ€™t
ultimately work on much at all.</p>


<p>The short answer was that I needed a function to be able to get a line of history, and based on the 
number of times pressing up or down. For my first attempt I said â€œnevermind this, Iâ€™ll just save my own history!â€
but that got hugely complicated very fast because it turns out, we donâ€™t just stupidly type commands over and over,
we are constantly using more characters on the keyboard than letters and numbers, retrieving old things to edit,
updating again, and in practice I found that I could keep up with simple parsing, but it would get out of sync
for a longer session. There also is the issue that people can tweak the amount of history saved, or how itâ€™s saved, 
and there are a set of environment <a href="https://www.redhat.com/sysadmin/history-command" target="_blank">variables and commands</a>
to do that. So most containers will start running and save history to memory and not file (and this makes
sense in case there is sensitive information) but it was problematic for me because I couldnâ€™t parse it.
For example, when someone presses up and down a bunch of times, I might see:</p>


<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>A[A[A[A[A[B[A
</code></pre></div>
</div>


<p>This is a reference to some previous command that I can only find in history
given Iâ€™m parsing the input/output as I am. So my second attempt (well, maybe second through
tenth) I was trying different variations of trying to be able to parse the history.
If you looked at <a href="https://twitter.com/ajdecon/status/1492381132998033409" target="_blank">the tweet</a>
youâ€™ll see we need to run:</p>


<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">history</span> <span class="nt">-a</span>
</code></pre></div>
</div>


<p>to start writing whatâ€™s in memory to file. I didnâ€™t want to do this on every command, because along
with the user seeing it and the UI being awful, it was just too much. Instead, I realized that I had a small
opportunity when the user first shells into the container (and is expecting a jump in their UI) to run whatever
I need and then clear the terminal. So I ran it there, right before a clear and welcome message.</p>


<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="k">def</span> <span class="nf">welcome</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">openpty</span><span class="p">):</span>
        <span class="s">"""
        Welcome the user and clear terminal
        """</span>
        <span class="c1"># Don't add commands executed to history
</span>        <span class="n">os</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">openpty</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">" export PROMPT_COMMAND='history -a'</span><span class="se">\r</span><span class="s">"</span><span class="p">))</span>
        <span class="n">os</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">openpty</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">" clear</span><span class="se">\r</span><span class="s">"</span><span class="p">))</span>
        <span class="n">os</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">openpty</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">" ### Welcome to PAKS! ###</span><span class="se">\r</span><span class="s">"</span><span class="p">))</span>

</code></pre></div>
</div>


<p>And with this method you arenâ€™t aware of the extra commands at all! And did you notice the spaces above? Thatâ€™s also another trick! Any command that you type with a leading
space wonâ€™t be saved to history, and this is thanks to <a href="https://unix.stackexchange.com/questions/115934/why-does-bash-have-a-histcontrol-ignorespace-option">HISTCONTROL</a> that has an ignorespace option. I think most people / containers
set it to ignore space and to ignore duplicates:</p>


<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">root</span><span class="o">@</span><span class="mi">1</span><span class="n">c268386714a</span><span class="p">:</span><span class="o">/</span><span class="c1"># echo $HISTCONTROL
</span><span class="n">ignoredups</span><span class="p">:</span><span class="n">ignorespace</span>

</code></pre></div>
</div>


<p>That said, I donâ€™t explicitly try to reset this in the container, so that could be a bug
if there is a container base that doesnâ€™t do that. And Iâ€™m pretty sure centos doesnâ€™t come with clear!
Iâ€™ll likely need to work on this a bit more.</p>


<blockquote>
  <p>For now, please consider this only working for debian/ubuntu bases and we can inspect the other ones later!</p>

</blockquote>

<p>Okay, so now letâ€™s look at the function to get history (self.hist.run). For now, just ignore the command to
get the history, thatâ€™s actually done via a Paks command that we will talk about after.
Here is what is going on:</p>


<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">openpty</span><span class="p">):</span>
    <span class="s">"""
    Given an input with some number of up/down and newline, derive command.
    """</span>
    <span class="c1"># Calculate the absolute change of ups/downs
</span>    <span class="n">up</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="s">"[A"</span><span class="p">)</span>
    <span class="n">down</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="s">"[B"</span><span class="p">)</span>
    <span class="n">change</span> <span class="o">=</span> <span class="n">up</span> <span class="o">-</span> <span class="n">down</span>

    <span class="c1"># pushed down below history (maybe they are angry?)
</span>    <span class="k">if</span> <span class="n">change</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
       <span class="k">return</span> <span class="s">""</span>

    <span class="c1"># Retrieve history, actually via a command run from the outside to get the file
</span>    <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">hist</span><span class="p">.</span><span class="n">run</span><span class="p">(</span>
        <span class="n">container_name</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">uri</span><span class="p">.</span><span class="n">extended_name</span><span class="p">,</span>
        <span class="n">out</span><span class="o">=</span><span class="n">openpty</span><span class="p">,</span>
        <span class="n">history_file</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">.</span><span class="n">history_file</span><span class="p">,</span>
        <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">.</span><span class="n">user</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">history</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">history</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">]</span>

    <span class="c1"># No history, nothing to return
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">history</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">""</span>

    <span class="c1"># The change is outside the length of history
</span>    <span class="k">if</span> <span class="n">change</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">""</span>

    <span class="c1"># here we are looking back up into history (negative index)
</span>    <span class="n">newline</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">change</span><span class="p">]</span>

    <span class="c1"># Add back any characters typed AFTER the up/down presses
</span>    <span class="n">newline</span> <span class="o">+=</span> <span class="n">re</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"(\[A|\[B)"</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">newline</span>
</code></pre></div>
</div>


<p>The above might not be perfect, but it worked the best for everything that I tried!
This allows us to issue a command that paks knows, press up to get it again, and then edit
it and have the command work correctly. Speaking of commandsâ€¦</p>


<h3 id="commands">Commands</h3>

<p>The core meat of paks is the commands that it recognizes. Every command has a <a href="https://github.com/syspack/paks/blob/ab61458a061c555434e5d3406914612fd1d60442/paks/commands/command.py#L26" target="_blank">base class</a>
that is going to handle parsing a line (with a main command and optional args or kwargs, depending on the command),
ensuring all required variables are passed (this is largely internal to the library and even a developer user
doesnâ€™t need to think about it unless they want to change what is passed), and then providing functions for basic kinds of
execution. So letâ€™s step back and first look at how we find a command (or executor). Basically, once we have a newline
and weâ€™ve parsed it per the above (looking up history and such) we can sniff it to see if it matches a known
command pattern:</p>


<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># If we have a newline (and possibly a command)
</span><span class="k">if</span> <span class="n">has_newline</span><span class="p">:</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">run_executor</span><span class="p">(</span><span class="n">string_input</span><span class="p">,</span> <span class="n">openpty</span><span class="p">)</span>

    <span class="c1"># Add derived line to the history
</span>    <span class="n">os</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">openpty</span><span class="p">,</span> <span class="n">terminal_input</span><span class="p">)</span>
    <span class="n">string_input</span> <span class="o">=</span> <span class="s">""</span>
</code></pre></div>
</div>


<p>The function â€œrun_executorâ€ is going to make this call if there is a Paks command and handle it.
And no matter what, we reset our string input to be empty given that the user pressed enter, because
they are going to start typing fresh. But before that, this function â€œrun_executorâ€ is going to see
if there are any known commands, and if so, to run them! That function looks like this:</p>


<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">def</span> <span class="nf">run_executor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string_input</span><span class="p">,</span> <span class="n">openpty</span><span class="p">):</span>
    <span class="s">"""
    Given a string input, run executor
    """</span>
    <span class="c1"># Get out early if it's not a Paks command (always starts with #)
</span>    <span class="n">string_input</span> <span class="o">=</span> <span class="n">string_input</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"[A"</span><span class="p">,</span> <span class="s">""</span><span class="p">).</span><span class="n">replace</span><span class="p">(</span><span class="s">"[B"</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">string_input</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">"#"</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="c1"># Do we have a matching executor?
</span>    <span class="n">executor</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">commands</span><span class="p">.</span><span class="n">get_executor</span><span class="p">(</span><span class="n">string_input</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">openpty</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">executor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>

        <span class="c1"># Print any message it wants to the terminal before run...
</span>        <span class="k">if</span> <span class="n">executor</span><span class="p">.</span><span class="n">pre_message</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n\r</span><span class="s">"</span> <span class="o">+</span> <span class="n">executor</span><span class="p">.</span><span class="n">pre_message</span><span class="p">)</span>

        <span class="c1"># Run it!
</span>        <span class="n">result</span> <span class="o">=</span> <span class="n">executor</span><span class="p">.</span><span class="n">run</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">image</span><span class="p">,</span>
            <span class="n">container_name</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">uri</span><span class="p">.</span><span class="n">extended_name</span><span class="p">,</span>
            <span class="n">original</span><span class="o">=</span><span class="n">string_input</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># And any message it wants to print after
</span>        <span class="k">if</span> <span class="n">result</span><span class="p">.</span><span class="n">message</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\r</span><span class="s">"</span> <span class="o">+</span> <span class="n">result</span><span class="p">.</span><span class="n">message</span><span class="p">)</span>
</code></pre></div>
</div>


<p>The result object holds what you would expect - a return code, some message,
and the basic outputs of the call. Itâ€™s up to the executor (command) to decide
what to show the user. Some might not show anything beyond commands that are run
with the executor. So what does that function â€œget_executorâ€ look like?
This is where we delive into the commands module, where there is a simple lookup of
the starting prefixes of commands matched to Command classes:</p>


<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1"># lookup of named commands and settings
</span><span class="n">docker_commands</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"#save"</span><span class="p">:</span> <span class="n">SaveContainer</span><span class="p">,</span>
    <span class="s">"#inspect"</span><span class="p">:</span> <span class="n">InspectContainer</span><span class="p">,</span>
    <span class="s">"#envload"</span><span class="p">:</span> <span class="n">EnvLoad</span><span class="p">,</span>
    <span class="s">"#envhost"</span><span class="p">:</span> <span class="n">EnvHost</span><span class="p">,</span>
    <span class="s">"#envsave"</span><span class="p">:</span> <span class="n">EnvSave</span><span class="p">,</span>
    <span class="s">"#cp"</span><span class="p">:</span> <span class="n">Copy</span><span class="p">,</span>
    <span class="s">"#size"</span><span class="p">:</span> <span class="n">Size</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
</div>


<p>When I add a load functionality, all it will need to do is update this dictionary.
And the reason those are â€œdocker commandsâ€ is that you can imagine we eventually
support other container technologies, and the commands you run are going to vary.
Each Command actually has a class attribute for the container types that are supported.
Here is a snippet of the DockerCommands class attached to the client that we are calling â€œget_executorâ€ on:</p>


<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">class</span> <span class="nc">DockerCommands</span><span class="p">:</span>

    <span class="c1"># Required kwargs for any docker/podman command to run
</span>    <span class="n">required</span> <span class="o">=</span> <span class="p">[</span><span class="s">"container_name"</span><span class="p">,</span> <span class="s">"name"</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container_tech</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">container_tech</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">lookup</span> <span class="o">=</span> <span class="n">docker_commands</span>

    <span class="k">def</span> <span class="nf">parse_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">" "</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parts</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">replace</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">""</span><span class="p">).</span><span class="n">replace</span><span class="p">(</span><span class="s">"</span><span class="se">\r</span><span class="s">"</span><span class="p">,</span> <span class="s">""</span><span class="p">).</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">has_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">parse_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">lookup</span>

    <span class="o">@</span><span class="nb">property</span>
    <span class="k">def</span> <span class="nf">history</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">History</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">command</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_executor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">"""
        Backend is required to update history
        """</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">parse_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">lookup</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">lookup</span><span class="p">[</span><span class="n">name</span><span class="p">](</span><span class="bp">self</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">required</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
</code></pre></div>
</div>


<p>To focus on the last function, you basically see that we parse the line (name), and then
see if itâ€™s in our lookup. If so, we return the initialized executor, and we need to add
the output source in case it needs to interact with the current terminal. The self.command
refers to the container technology (e.g., docker or podman in this case).</p>


<p>Then we can look at a particular command (e.g., inspect) and see itâ€™s pretty simple! We have defined
the supported container technologies along with optional messages, and a main run function. Here is the command
to inspect, which will dump out the json manifest and optionally take a section:</p>


<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">class</span> <span class="nc">InspectContainer</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span>

    <span class="n">supported_for</span> <span class="o">=</span> <span class="p">[</span><span class="s">"docker"</span><span class="p">,</span> <span class="s">"podman"</span><span class="p">]</span>
    <span class="n">pre_message</span> <span class="o">=</span> <span class="s">"Inspecting Container..."</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="s">"""
        Inspect a container fully, or specific sections
        """</span>
        <span class="c1"># Always run this first to make sure container tech is valid
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">check</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># These are both required for docker/podman
</span>        <span class="n">container_name</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s">"container_name"</span><span class="p">]</span>

        <span class="c1"># inspect particular attributes provided as args
</span>        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">run_command</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="bp">self</span><span class="p">.</span><span class="n">tech</span><span class="p">,</span>
                        <span class="s">"inspect"</span><span class="p">,</span>
                        <span class="s">"--format"</span><span class="p">,</span>
                        <span class="s">"{{json .%s }}"</span> <span class="o">%</span> <span class="n">section</span><span class="p">.</span><span class="n">capitalize</span><span class="p">(),</span>
                        <span class="n">container_name</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">)</span>

        <span class="c1"># Otherwise just dump the whole thing
</span>        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">run_command</span><span class="p">([</span><span class="bp">self</span><span class="p">.</span><span class="n">tech</span><span class="p">,</span> <span class="s">"inspect"</span><span class="p">,</span> <span class="n">container_name</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">result</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">return_success</span><span class="p">()</span>
</code></pre></div>
</div>


<p>Youâ€™ll now know the main Paks trick - because we are still running on the host,
we can issue commands to the host while we are in the container! In the above, we can just type:</p>


<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c">#inspect</span>
<span class="c">#inspect config</span>
</code></pre></div>
</div>


<p>And see the output in the terminal! This is how a lot of the interactions with the host work.
Itâ€™s kind of simple and silly, but also really cool when you see it work on the container!
So the run function above, just as a reminder, is called by this part:</p>


<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">result</span> <span class="o">=</span> <span class="n">executor</span><span class="p">.</span><span class="n">run</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">image</span><span class="p">,</span>
    <span class="n">container_name</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">uri</span><span class="p">.</span><span class="n">extended_name</span><span class="p">,</span>
    <span class="n">original</span><span class="o">=</span><span class="n">string_input</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>
</div>


<p>And honestly, thatâ€™s the majority of Paks! ğŸ‰ï¸</p>


<h2 id="discussion">Discussion</h2>

<p>Paks has  honestly been so fun to work on, despite long hours of trying to figure things out during evenings and weekends. Iâ€™m so excited
about the ideas, and I want to share them with others because I think developer tools for containers
are kind of lacking. Heck, I stayed up until like 4am writing this post. No, I donâ€™t normally do that,
I had some things on my mind, but it was an excellent use of the time, despite the fact that I woke up 4 hours later and
Iâ€™m going to crash tonight (err tomorrow nightâ€¦ err now that Iâ€™m tweaking up the finishing touches to this post)!</p>


<h3 id="next-steps">Next Steps</h3>

<p>Iâ€™m working on a â€œpaks loadâ€ command that will let someone develop a Python module
with some set of commands for their custom use case. The first thing I wanted to try
was to generate sboms for spack (e.g., â€œGenerate sboms for this spack install in the container
and save them to my host so I can upload alongside the container to a registry). I had
some <a href="https://github.com/spack/spack-sbom" target="_blank">previous work</a> to use 
spack scripting, but ultimately this weekend did a <a href="https://github.com/spack/spack/pull/28909" target="_blank">pull request</a>
to add sbom generation to spack proper. And then Iâ€™ll be able to work on the load commands.
I also want to address some of the anticipated bugs I mentioned above, like properly setting â€œHISTCONTROLâ€
to ensure we donâ€™t save commands issued by the client to history, and possibly having a cleanup step on save
that removes the file. I havenâ€™t added this yet is because if Iâ€™m developing in the container 
and want to say, move it from my local machine to HPC, I kind of want to have my history so I can lazily use it.</p>


<h3 id="but-really">But Reallyâ€¦</h3>

<p>We have some magic up our sleeves for what we are actually working on to inspire these ideas!
I guess youâ€™ll just have to wait for the future, because <a href="https://github.com/alecbcs" target="_blank">@alecbcs</a> and
I are both have vision and are a great tag team! ğŸ‰ï¸</p>


<h3 id="security">Security</h3>

<p>So there are obviously security issues around a library like this - and I added notes
to the documentation that Iâ€™ll re-iterate here. Paks is intended for use by a developer
that is in their own trusted environment, whether local or on HPC. Because there is an interaction
with the host, you wouldnâ€™t use this in production someone to give users an ability to load
environments or save. You also wouldnâ€™t want to save a development container with something
private in history and push it. Iâ€™m still an advocate for, after development is done,
pushing changed code to GitHub and having an automated build build, test, and deploy.
Could we eventually have a production grade library to enable interactions inside the
container? Possibly, but itâ€™s not Paks in Python in its current state. I think
thatâ€™s okay - we have to start small with ideas and go from there.</p>


<h3 id="didnt-i-see-paks-before">Didnâ€™t I see paks before?</h3>

<p>Yes, you did! A previous version was intended for making spack build caches on GitHub, but that
didnâ€™t work because you couldnâ€™t build a spack package within a container and then
pull the same container and install it and hit the cache. I think this might work someday,
hence why I havenâ€™t completely deleted the code, but I couldnâ€™t let a cute logo and colorscheme go to waste!
So for now itâ€™s on a separate branch but largely I am not working on it. If you want to see this branch,
itâ€™s still <a href="https://github.com/syspack/paks/tree/v1/spack" target="_blank">here</a>!</p>


<p>Thanks for reading friends! I hope this has been interesting and you might be inspired to
also work on better tooling for developers, even if that just means exploring the ideas.</p>